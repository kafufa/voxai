<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="VoxAI - Tu asistente de voz personal">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>VoxAI - Asistente de Voz</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body>
    <main>
        <!-- Contenedor para el formulario de inicio de sesi√≥n -->
        <section id="login-container" class="container">
            <h1>VoxAI - Tu Asistente de Voz</h1>
            <form id="login-form" action="#" method="post" autocomplete="off">
                <h2>Iniciar Sesi√≥n</h2>
                <div class="form-group">
                    <label for="username">Usuario</label>
                    <input type="text" id="username" name="username" placeholder="Ingresa tu usuario" required>
                </div>
                <div class="form-group">
                    <label for="password">Contrase√±a</label>
                    <div class="password-container">
                        <input type="password" id="password" name="password" placeholder="Ingresa tu contrase√±a" required>
                        <button type="button" id="toggle-password" aria-label="Mostrar contrase√±a">
                            <span class="eye-icon">üëÅÔ∏è</span>
                        </button>
                    </div>
                </div>
                <button type="submit" id="login-btn" class="primary-btn">Ingresar</button>
                <div id="login-error" class="error-message" role="alert" aria-live="assertive"></div>
            </form>
        </section>

        <!-- Contenedor para el asistente de voz -->
        <section id="assistant-container" class="container hidden">
            <h2>Asistente de Voz</h2>
            <div class="voice-controls">
                <button id="start-btn" class="voice-btn">
                    <span class="mic-icon">üé§</span>
                    <span class="btn-text">Comenzar Reconocimiento</span>
                </button>
                <button id="stop-btn" class="voice-btn hidden">
                    <span class="stop-icon">‚èπÔ∏è</span>
                    <span class="btn-text">Detener</span>
                </button>
            </div>
            <div class="status-indicator">
                <span id="status-text">Esperando...</span>
                <div id="waves" class="hidden">
                    <span class="wave"></span>
                    <span class="wave"></span>
                    <span class="wave"></span>
                </div>
            </div>
            <div id="response-container" class="response-box" role="region" aria-live="polite">
                <p id="response"></p>
            </div>
            <button id="logout-btn" class="secondary-btn">Cerrar Sesi√≥n</button>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 VoxAI - Todos los derechos reservados</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Objeto que almacena los usuarios y sus contrase√±as (en producci√≥n, esto deber√≠a estar en el servidor)
            const users = {
                "Marouan": "M@r0u@n!2024",
                "Ivan": "1v@n_Seguro99",
                "Noa": "N0a$ClaveXyz"
            };

            // Referencias a elementos del DOM
            const loginForm = document.getElementById("login-form");
            const loginContainer = document.getElementById("login-container");
            const assistantContainer = document.getElementById("assistant-container");
            const usernameInput = document.getElementById("username");
            const passwordInput = document.getElementById("password");
            const loginError = document.getElementById("login-error");
            const startBtn = document.getElementById("start-btn");
            const stopBtn = document.getElementById("stop-btn");
            const responseElement = document.getElementById("response");
            const statusText = document.getElementById("status-text");
            const waves = document.getElementById("waves");
            const togglePasswordBtn = document.getElementById("toggle-password");
            const logoutBtn = document.getElementById("logout-btn");

            // Funci√≥n para mostrar/ocultar contrase√±a
            togglePasswordBtn.addEventListener("click", function() {
                const type = passwordInput.getAttribute("type") === "password" ? "text" : "password";
                passwordInput.setAttribute("type", type);
                this.querySelector(".eye-icon").textContent = type === "password" ? "üëÅÔ∏è" : "üîí";
            });

            // Gestionar el inicio de sesi√≥n
            loginForm.addEventListener("submit", function(e) {
                e.preventDefault();
                
                const username = usernameInput.value.trim();
                const password = passwordInput.value;

                // Verificar credenciales
                if (users[username] && users[username] === password) {
                    // Guardar nombre de usuario en sessionStorage (no para contrase√±as)
                    sessionStorage.setItem("currentUser", username);
                    
                    // Mostrar interfaz del asistente
                    loginContainer.classList.add("hidden");
                    assistantContainer.classList.remove("hidden");
                    
                    // Bienvenida personalizada
                    responseElement.textContent = `Bienvenido ${username}. ¬øEn qu√© puedo ayudarte hoy?`;
                } else {
                    // Mostrar error
                    loginError.textContent = "Usuario o contrase√±a incorrectos";
                    loginError.classList.add("show");
                    
                    // Eliminar mensaje de error despu√©s de 3 segundos
                    setTimeout(() => {
                        loginError.classList.remove("show");
                    }, 3000);
                }
            });

            // Variables para el reconocimiento de voz
            let recognition = null;
            let isListening = false;

            // Inicializar el reconocimiento de voz
            function setupSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    responseElement.textContent = "Lo siento, tu navegador no soporta reconocimiento de voz.";
                    startBtn.disabled = true;
                    return false;
                }
                
                recognition = new SpeechRecognition();
                recognition.lang = "es-ES";
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onstart = function() {
                    isListening = true;
                    statusText.textContent = "Escuchando...";
                    waves.classList.remove("hidden");
                    startBtn.classList.add("hidden");
                    stopBtn.classList.remove("hidden");
                };
                
                recognition.onend = function() {
                    isListening = false;
                    statusText.textContent = "Esperando...";
                    waves.classList.add("hidden");
                    startBtn.classList.remove("hidden");
                    stopBtn.classList.add("hidden");
                };
                
                recognition.onerror = function(event) {
                    console.error("Error en reconocimiento:", event.error);
                    responseElement.textContent = `Error: ${event.error === 'not-allowed' ? 'Necesito permiso para usar el micr√≥fono' : 'No pude entenderte. Int√©ntalo de nuevo.'}`;
                    recognition.stop();
                };
                
                recognition.onresult = handleVoiceResult;
                
                return true;
            }

            // Procesar el resultado del reconocimiento de voz
            function handleVoiceResult(event) {
                const transcript = event.results[0][0].transcript.trim();
                responseElement.textContent = "Procesando: " + transcript;
                
                // Verificar si es una solicitud de cierre de sesi√≥n
                if (transcript.toLowerCase().includes("cerrar sesi√≥n") || 
                    transcript.toLowerCase().includes("salir") || 
                    transcript.toLowerCase().includes("logout")) {
                    logout();
                    return;
                }

                // Enviar la transcripci√≥n para procesamiento
                statusText.textContent = "Procesando...";
                
                // Usar constantes para API endpoint
                const API_ENDPOINT = "https://hook.eu2.make.com/sw3ligopuhaxs11xorsf61ia5apje4hy";
                
                fetch(API_ENDPOINT, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-User-ID": sessionStorage.getItem("currentUser") // Identificar al usuario en la solicitud
                    },
                    body: JSON.stringify({ 
                        query: transcript,
                        timestamp: new Date().toISOString()
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Error de red: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    responseElement.textContent = data.response || "Respuesta recibida sin contenido";
                    
                    // Opcional: Leer la respuesta en voz alta
                    if ('speechSynthesis' in window) {
                        const utterance = new SpeechSynthesisUtterance(data.response);
                        utterance.lang = "es-ES";
                        speechSynthesis.speak(utterance);
                    }
                })
                .catch(error => {
                    console.error("Error:", error);
                    responseElement.textContent = "Hubo un error al procesar tu solicitud. Por favor, int√©ntalo de nuevo.";
                })
                .finally(() => {
                    statusText.textContent = "Esperando...";
                });
            }

            // Iniciar reconocimiento de voz
            startBtn.addEventListener("click", function() {
                if (!recognition && !setupSpeechRecognition()) {
                    return;
                }
                
                try {
                    recognition.start();
                } catch (error) {
                    console.error("Error al iniciar reconocimiento:", error);
                    
                    // Reiniciar reconocimiento si ya estaba activo
                    if (error.name === 'InvalidStateError') {
                        recognition.stop();
                        setTimeout(() => recognition.start(), 200);
                    }
                }
            });

            // Detener reconocimiento de voz
            stopBtn.addEventListener("click", function() {
                if (recognition && isListening) {
                    recognition.stop();
                }
            });

            // Funci√≥n de cierre de sesi√≥n
            function logout() {
                sessionStorage.removeItem("currentUser");
                assistantContainer.classList.add("hidden");
                loginContainer.classList.remove("hidden");
                responseElement.textContent = "";
                usernameInput.value = "";
                passwordInput.value = "";
            }

            // Bot√≥n de cierre de sesi√≥n
            logoutBtn.addEventListener("click", logout);

            // Comprobar si hay una sesi√≥n activa (por ejemplo, si se recarga la p√°gina)
            const currentUser = sessionStorage.getItem("currentUser");
            if (currentUser && users[currentUser]) {
                loginContainer.classList.add("hidden");
                assistantContainer.classList.remove("hidden");
                responseElement.textContent = `Bienvenido de nuevo, ${currentUser}. ¬øEn qu√© puedo ayudarte hoy?`;
            }

            // Detectar cuando la ventana pierde el foco y detener el reconocimiento
            window.addEventListener("blur", function() {
                if (recognition && isListening) {
                    recognition.stop();
                }
            });

            // Intentar inicializar el reconocimiento de voz al cargar
            setupSpeechRecognition();
        });
    </script>
</body>
</html>
