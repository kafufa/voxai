<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VoxAI - Asistente de Voz</title>
   <link rel="stylesheet" href="styles2.css"> 
</head>

<body>
    <div id="assistant-container" class="container">
        <h1>🤖 VoxAI - Asistente de Voz</h1>
        <p>Habla o escribe para interactuar con la IA de DeepSeek.</p>
        <button id="start-btn" class="btn talk">🎤 Hablar</button>
        <button id="stop-btn" class="btn stop" style="display: none;">🛑 Parar</button>
        <input type="text" id="text-input" class="input-box" placeholder="Escribe tu mensaje aquí...">
        <button id="send-btn" class="btn send">📩 Enviar</button>
        <p id="response" class="response-box">Esperando comando...</p>
    </div>
    <div>
        <button class="nav-button" onclick="location.href='https://kafufa.github.io/voxai/apartados.html'">Apartados</button>
    </div>
    
    <script>
        // Elementos del DOM
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const textInput = document.getElementById('text-input');
        const sendBtn = document.getElementById('send-btn');
        const responseBox = document.getElementById('response');
        
        // Variables globales
        let recognition;
        let isListening = false;
        const apiURL = 'https://kafufa.github.io/voxai/backend/env';
        
        // Verificar si el navegador soporta reconocimiento de voz
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        
        // Función para inicializar el reconocimiento de voz
        function initializeSpeechRecognition() {
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.lang = 'es-ES';
                recognition.continuous = true;
                recognition.interimResults = false;
                
                recognition.onstart = function() {
                    isListening = true;
                    startBtn.style.display = 'none';
                    stopBtn.style.display = 'inline-block';
                    startBtn.classList.add('listening');
                    responseBox.textContent = 'Escuchando...';
                };
                
                recognition.onresult = function(event) {
                    const transcript = Array.from(event.results)
                        .map(result => result[0])
                        .map(result => result.transcript)
                        .join('');
                    
                    textInput.value = transcript;
                };
                
                recognition.onend = function() {
                    if (isListening) {
                        // Si todavía debería estar escuchando, reinicie el reconocimiento
                        // (esto ayuda con el límite de tiempo de algunos navegadores)
                        recognition.start();
                    } else {
                        startBtn.style.display = 'inline-block';
                        stopBtn.style.display = 'none';
                        startBtn.classList.remove('listening');
                        responseBox.textContent = 'Reconocimiento de voz detenido.';
                    }
                };
                
                recognition.onerror = function(event) {
                    console.error('Error en reconocimiento de voz:', event.error);
                    isListening = false;
                    startBtn.style.display = 'inline-block';
                    stopBtn.style.display = 'none';
                    startBtn.classList.remove('listening');
                    responseBox.textContent = `Error: ${event.error}. Intenta de nuevo.`;
                };
            } else {
                startBtn.disabled = true;
                startBtn.textContent = '🚫 No soportado';
                responseBox.textContent = 'Tu navegador no soporta reconocimiento de voz.';
            }
        }
        
        // Iniciar reconocimiento de voz
        function startListening() {
            if (recognition) {
                try {
                    recognition.start();
                } catch (error) {
                    // Si ya está ejecutándose, reinícielo
                    recognition.stop();
                    setTimeout(() => recognition.start(), 200);
                }
            } else {
                initializeSpeechRecognition();
                setTimeout(() => {
                    if (recognition) recognition.start();
                }, 200);
            }
        }
        
        // Detener reconocimiento de voz
        function stopListening() {
            if (recognition) {
                isListening = false;
                recognition.stop();
            }
        }
        
        // Función para enviar la solicitud a la API
        async function sendToAPI(message) {
            try {
                responseBox.textContent = `Tú: ${message}\n\nConectando con DeepSeek...`;
                
                const response = await fetch(apiURL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ query: message })
                });
                
                if (!response.ok) {
                    throw new Error(`Error de API: ${response.status}`);
                }
                
                const data = await response.json();
                return data.response || "No se pudo obtener una respuesta de la API.";
            } catch (error) {
                console.error("Error al conectar con la API:", error);
                return `Lo siento, hubo un error al conectar con la API: ${error.message}`;
            }
        }
        
        // Función para procesar y enviar el mensaje
        async function processMessage() {
            const userMessage = textInput.value.trim();
            if (!userMessage) return;
            
            // Detener el reconocimiento de voz si está activo
            if (isListening) {
                stopListening();
            }
            
            // Mostrar el mensaje del usuario
            responseBox.textContent = `Tú: ${userMessage}\n\nProcesando...`;
            
            try {
                // Enviar el mensaje a la API y obtener la respuesta
                const apiResponse = await sendToAPI(userMessage);
                
                // Mostrar la respuesta
                responseBox.textContent = `Tú: ${userMessage}\n\nAsistente: ${apiResponse}`;
                
                // Opcionalmente, utilizar síntesis de voz para leer la respuesta
                if (window.speechSynthesis) {
                    const speech = new SpeechSynthesisUtterance(apiResponse);
                    speech.lang = 'es-ES';
                    window.speechSynthesis.speak(speech);
                }
            } catch (error) {
                responseBox.textContent = `Tú: ${userMessage}\n\nError: No se pudo procesar tu solicitud. Por favor, intenta de nuevo.`;
            }
            
            // Limpiar el campo de entrada
            textInput.value = '';
        }
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', initializeSpeechRecognition);
        
        startBtn.addEventListener('click', startListening);
        
        stopBtn.addEventListener('click', stopListening);
        
        sendBtn.addEventListener('click', processMessage);
        
        textInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                processMessage();
            }
        });
    </script>
</body>
</html>
